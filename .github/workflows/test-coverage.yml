name: Update Test Coverage

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  test:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Xcode
        run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

      - name: Run tests with coverage
        run: |
          xcodebuild test \
            -project Weather.xcodeproj \
            -scheme Weather \
            -destination 'platform=iOS Simulator,name=iPhone 14' \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult | tee xcodebuild.log

      - name: Check if coverage data exists
        run: |
          if ! xcrun xccov view --report TestResults.xcresult > /dev/null 2>&1; then
            echo "❌ No coverage data found. Ensure tests are generating coverage."
            exit 1
          fi

      - name: Extract coverage data
        run: |
          mkdir -p coverage
          xcrun xccov view --report --json TestResults.xcresult > coverage/coverage.json

      - name: Commit and push coverage report
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add coverage/coverage.json
          git commit -m "Update test coverage report" || exit 0
          git push
