# .github/workflows/test-coverage.yml
name: Update Test Coverage

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  test:
    runs-on: macOS-15
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Use latest available Xcode version
        run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

      - name: Resolve Swift Package Dependencies
        run: xcodebuild -resolvePackageDependencies

      - name: Build Tests
        run: |
          xcodebuild build \
            -project Weather.xcodeproj \
            -scheme ExistingSchemeName \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            | tee xcodebuild.log

      - name: Run tests with coverage
        run: |
          xcodebuild test \
            -project Weather.xcodeproj \
            -scheme Weather \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult | tee xcodebuild.log
        continue-on-error: true

      - name: Debug test failure (if any)
        if: failure()
        run: |
          tail -n 100 xcodebuild.log

      - name: Verify coverage data
        run: |
          if ! [ -d "TestResults.xcresult" ]; then
            echo "❌ Test results not found. Check test logs."
            exit 1
          fi
          if ! xcrun xccov view --report TestResults.xcresult > /dev/null 2>&1; then
            echo "❌ No coverage data found. Ensure tests are generating coverage."
            exit 1
          fi

      - name: Move coverage.json to repo root
        run: |
          mv coverage/coverage.json coverage.json

      - name: Extract and format coverage data for badge
        run: |
          # Extract coverage percentage
          COVERAGE=$(xcrun xccov view --report TestResults.xcresult | awk '/lines\./ { print $3 }' | sed 's/%//')

          # Determine badge color dynamically
          if (( $(echo "$COVERAGE > 80" | bc -l) )); then
            COLOR="green"
          elif (( $(echo "$COVERAGE > 50" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="red"
          fi

          # Create JSON badge file
          echo "{ \"schemaVersion\": 1, \"label\": \"Test Coverage\", \"message\": \"${COVERAGE}%\", \"color\": \"${COLOR}\" }" > coverage.json

          # Debug output
          cat coverage.json

      - name: Commit and push coverage report
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "mrugama"
          git config --global user.email "mrugama@gmail.com"
          git remote set-url origin https://mrugama:${GH_PAT}@github.com/mrugama/Weather.git
          git add coverage.json
          git commit -m "Update test coverage report" || exit 0
          git push origin HEAD:master
